<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WatchApp ‚Äî –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</title>
  <style>
    :root{--bg:#0f1116;--card:#151822;--text:#e6e9f0;--muted:#98a2b3;--accent:#7aa2ff;--line:#222837;}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);}
    header{position:fixed;top:0;left:0;right:0;height:56px;background:var(--card);display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--line);z-index:10}
    header h1{font-size:18px;font-weight:600}
    main{padding:72px 16px 88px;max-width:960px;margin:0 auto}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px}
    .grid{display:grid;gap:12px}
    .btn{display:block;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#111523;color:var(--text);text-decoration:none;cursor:pointer}
    .btn:hover{border-color:#2e364a}
    .btn-ghost{background:transparent}
    .title{font-size:22px;font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#101422;cursor:pointer}
    .item h4{font-size:16px;margin-bottom:4px}
    .tabs{position:fixed;bottom:0;left:0;right:0;height:68px;background:var(--card);border-top:1px solid var(--line);display:flex;z-index:10}
    .tabs button{flex:1;border:none;background:transparent;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer}
    .tabs button.active{color:var(--accent)}
    .back{margin-bottom:12px}
    .article{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px}
    .article h1{font-size:22px;margin-bottom:10px}
    .breadcrumb{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .breadcrumb a{color:var(--accent);text-decoration:none}
    .empty{color:var(--muted);padding:16px 0}
    .loading{padding:8px 0;color:var(--muted)}
    a, .click{color:#8bb3ff}
  </style>
</head>
<body>
  <header><h1>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h1></header>
  <main id="app"><div class="panel"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div></main>

  <footer class="tabs">
    <button data-tab="info" class="active">‚åö<span>–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span></button>
    <button data-tab="brands">üè∑Ô∏è<span>–ë—Ä–µ–Ω–¥—ã</span></button>
    <button data-tab="articles">üì∞<span>–°—Ç–∞—Ç—å–∏</span></button>
  </footer>

  <script>
    // === API ===
    const BASE_API = "https://n-8-n.tech/webhook"; // –±–µ–∑ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–≥–æ —Å–ª—ç—à–∞!
    const API = {
      cats:    () => `${BASE_API}/kb/categories`,
      list:    (categoryId) => categoryId
                  ? `${BASE_API}/kb/articles?category=${encodeURIComponent(categoryId)}`
                  : `${BASE_API}/kb/articles`,
      article: (id) => `${BASE_API}/kb/article?id=${encodeURIComponent(id)}`,
    };

    // === Telegram initData (–µ—Å–ª–∏ –µ—Å—Ç—å) ===
    function getInitData() {
      try {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
          return window.Telegram.WebApp.initData;
        }
      } catch (_) {}
      return "";
    }
    async function apiGet(url) {
      const headers = {};
      const initData = getInitData();
      if (initData) headers["X-Init-Data"] = initData;
      const res = await fetch(url, { headers });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json().catch(async () => {
        // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –ø—Ä–∏—à—ë–ª –Ω–µ JSON (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—Å—Ç) ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
        const t = await res.text();
        try { return JSON.parse(t); } catch { return t; }
      });
    }

    // === —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
    const state = {
      tab: "info",
      tree: null,
      nodes: {
        general: null,
        brands: null,
        levels: {} // basic/advanced/pro
      },
      stack: [] // –¥–ª—è "–Ω–∞–∑–∞–¥"
    };

    // === helpers ===
    const app = document.getElementById("app");
    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if (k === "class") el.className = v;
        else if (k.startsWith("on")) el.addEventListener(k.slice(2), v);
        else el.setAttribute(k, v);
      });
      children.flat().forEach(c => {
        if (typeof c === "string") el.appendChild(document.createTextNode(c));
        else if (c) el.appendChild(c);
      });
      return el;
    }
    function clear(){ app.innerHTML = ""; }
    function setTab(tab){
      state.tab = tab;
      document.querySelectorAll(".tabs button").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
      if (tab === "info") renderInfoHome();
      if (tab === "brands") renderBrandsHome();
      if (tab === "articles") renderArticlesHome();
    }
    document.querySelectorAll(".tabs button").forEach(b => b.onclick = () => setTab(b.dataset.tab));

    // === –∑–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ä–µ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ===
    async function loadTree() {
      const data = await apiGet(API.cats());
      const tree = Array.isArray(data) ? data : (data.tree || []);
      state.tree = tree;

      // –Ω–∞—Ö–æ–¥–∏–º —É–∑–ª—ã "–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" –∏ "–ë—Ä–µ–Ω–¥—ã"
      const byId = id => tree.find(n => n.id === id);
      const byTitle = t => tree.find(n => (n.title||"").toLowerCase().includes(t));
      state.nodes.general = byId("general") || byTitle("–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
      state.nodes.brands  = byId("brands")  || byTitle("–±—Ä–µ–Ω–¥");
      if (state.nodes.general) {
        const kids = state.nodes.general.children || [];
        state.nodes.levels.basic    = kids.find(n => n.id === "basic")    || kids.find(n => /–±–∞–∑–æ–≤/i.test(n.title||""));
        state.nodes.levels.advanced = kids.find(n => n.id === "advanced") || kids.find(n => /–ø—Ä–æ–¥–≤–∏–Ω—É—Ç/i.test(n.title||""));
        state.nodes.levels.pro      = kids.find(n => n.id === "pro")      || kids.find(n => /–ø—Ä–æ—Ñ/i.test(n.title||""));
      }
    }

    // === –†–ï–ù–î–ï–†–´ ===
    function renderInfoHome(){
      clear();
      const g = state.nodes.general;
      if (!g) return app.appendChild(h("div",{class:"panel"}, h("div",{class:"empty"},"–ù–µ—Ç —Ä–∞–∑–¥–µ–ª–∞ ¬´–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è¬ª")));
      app.appendChild(
        h("div",{class:"panel"},
          h("div",{class:"title"},"–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"),
          h("div",{class:"grid"},
            h("button",{class:"btn",onclick:()=>renderLevel('basic')}, "–ë–∞–∑–æ–≤—ã–π"),
            h("button",{class:"btn",onclick:()=>renderLevel('advanced')}, "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π"),
            h("button",{class:"btn",onclick:()=>renderLevel('pro')}, "–ü—Ä–æ—Ñ–∏"),
          ),
        )
      );
    }

    function renderLevel(key){
      const levelNode = state.nodes.levels[key];
      clear();
      const back = h("button",{class:"btn btn-ghost back",onclick:()=>renderInfoHome()},"‚Üê –ù–∞–∑–∞–¥");
      const title = h("div",{class:"title"}, levelNode?.title || "–†–∞–∑–¥–µ–ª");
      const topics = (levelNode?.children || []);
      const list = h("div",{class:"list"},
        topics.map(cat =>
          h("div",{class:"item",onclick:()=>renderTopic(cat)}, h("h4",{},cat.title), h("div",{class:"muted"},"–û—Ç–∫—Ä—ã—Ç—å —Ç–µ–º—ã –∏ —Å—Ç–∞—Ç—å–∏"))
        )
      );
      app.appendChild(h("div",{class:"panel"}, back, title, list));
    }

    async function renderTopic(cat){
      clear();
      app.appendChild(h("div",{class:"panel"}, h("button",{class:"btn btn-ghost back",onclick:()=>renderLevelFromChild(cat)}, "‚Üê –ù–∞–∑–∞–¥"),
        h("div",{class:"title"},cat.title),
        h("div",{class:"loading"},"–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—å–∏‚Ä¶")
      ));
      try{
        const data = await apiGet(API.list(cat.id));
        const items = Array.isArray(data) ? data : (data.items || []);
        const list = items.length
          ? h("div",{class:"list"}, items.map(a =>
               h("div",{class:"item",onclick:()=>openArticle(a.id)},
                 h("h4",{},a.title || "–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞"),
                 a.summary ? h("div",{class:"muted"},a.summary) : null
               )))
          : h("div",{class:"empty"},"–°—Ç–∞—Ç–µ–π –≤ —ç—Ç–æ–π —Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç.");
        app.querySelector(".panel").lastChild.replaceWith(list);
      }catch(e){
        app.querySelector(".panel").lastChild.replaceWith(h("div",{class:"empty"},"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–µ–π"));
      }
    }
    function renderLevelFromChild(cat){
      // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —É—Ä–æ–≤–Ω—é, —É –∫–æ—Ç–æ—Ä–æ–≥–æ —ç—Ç–æ—Ç cat —è–≤–ª—è–µ—Ç—Å—è –¥–æ—á–µ—Ä–Ω–∏–º
      const keys = ["basic","advanced","pro"];
      const key = keys.find(k => (state.nodes.levels[k]?.children||[]).some(c=>c.id===cat.id));
      if (key) renderLevel(key); else renderInfoHome();
    }

    function renderBrandsHome(){
      clear();
      const b = state.nodes.brands;
      if (!b) return app.appendChild(h("div",{class:"panel"}, h("div",{class:"empty"},"–ù–µ—Ç —Ä–∞–∑–¥–µ–ª–∞ ¬´–ë—Ä–µ–Ω–¥—ã¬ª")));
      const list = (b.children||[]).map(cat =>
        h("div",{class:"item",onclick:()=>renderTopic(cat)},
          h("h4",{}, cat.title)
        )
      );
      app.appendChild(h("div",{class:"panel"}, h("div",{class:"title"},"–ë—Ä–µ–Ω–¥—ã"), h("div",{class:"list"}, list)));
    }

    async function renderArticlesHome(){
      clear();
      app.appendChild(h("div",{class:"panel"},
        h("div",{class:"title"},"–í—Å–µ —Å—Ç–∞—Ç—å–∏"),
        h("div",{class:"loading"},"–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶")
      ));
      try{
        const data = await apiGet(API.list()); // –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ = –≤—Å–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ
        const items = Array.isArray(data) ? data : (data.items || []);
        const list = items.length
          ? h("div",{class:"list"}, items.map(a =>
               h("div",{class:"item",onclick:()=>openArticle(a.id)},
                 h("h4",{},a.title || "–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞"),
                 a.summary ? h("div",{class:"muted"},a.summary) : null
               )))
          : h("div",{class:"empty"},"–ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–µ–π.");
        app.querySelector(".panel").lastChild.replaceWith(list);
      }catch(e){
        app.querySelector(".panel").lastChild.replaceWith(h("div",{class:"empty"},"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏."));
      }
    }

    async function openArticle(id){
      clear();
      app.appendChild(h("div",{class:"panel"},
        h("button",{class:"btn btn-ghost back",onclick:()=>window.history.back()},"‚Üê –ù–∞–∑–∞–¥"),
        h("div",{class:"loading"},"–û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—å—é‚Ä¶")
      ));
      try{
        const data = await apiGet(API.article(id));
        const article = data.article || (Array.isArray(data) ? data[0] : data);
        const box = h("div",{class:"article"});
        box.innerHTML = `<h1>${escapeHtml(article?.title || "–°—Ç–∞—Ç—å—è")}</h1>` + (article?.content_html || "<p class='muted'>–ü—É—Å—Ç–æ</p>");
        app.querySelector(".panel").lastChild.replaceWith(box);
      }catch(e){
        app.querySelector(".panel").lastChild.replaceWith(h("div",{class:"empty"},"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å—é."));
      }
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

    // –∑–∞–ø—É—Å–∫
    (async()=>{
      try{
        await loadTree();
      }catch(e){
        app.innerHTML = `<div class="panel"><div class="empty">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ–∑–∂–µ.</div></div>`;
        return;
      }
      setTab("info");
    })();
  </script>
</body>
</html>
