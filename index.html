<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>База знаний · Demo Web App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: #0f1117;         /* фон */
      --card: #161a23;       /* карточки */
      --muted: #94a3b8;      /* вторичный текст */
      --text: #e5e7eb;       /* основной текст */
      --brand: #60a5fa;      /* синий */
      --accent: #22d3ee;     /* бирюзовый */
      --ok: #10b981;         /* зелёный */
      --border: #232838;     /* рамка */
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}

    .wrap{max-width:840px;margin:0 auto;padding:16px 16px calc(80px + env(safe-area-inset-bottom));}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,17,23,1),rgba(15,17,23,.85));backdrop-filter:saturate(1.2) blur(6px);z-index:20;border-bottom:1px solid var(--border)}
    header .row{max-width:840px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
    .logo{display:flex;gap:10px;align-items:center}
    .logo i{width:22px;height:22px;display:inline-grid;place-items:center;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--accent));box-shadow:inset 0 0 18px rgba(255,255,255,.2)}
    .logo b{font-weight:700}

    .view{display:none}
    .view.active{display:block}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (min-width:720px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr))} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .card.click{cursor:pointer;transition:transform .15s ease, border-color .15s ease}
    .card.click:hover{transform:translateY(-2px);border-color:var(--brand)}

    .muted{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#d1fae5;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);padding:3px 8px;border-radius:999px}

    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:12px;background:var(--card);border:1px solid var(--border);cursor:pointer;transition:transform .15s ease,border-color .15s ease}
    .item:hover{transform:translateY(-1px);border-color:var(--brand)}
    .item .ico{width:20px;opacity:.9;margin-top:2px}
    .item h4{margin:0 0 4px 0;font-size:15px}
    .item .meta{font-size:12px;color:var(--muted)}

    .crumbs{display:flex;gap:6px;align-items:center;color:var(--muted);font-size:13px;margin:4px 0 12px}
    .crumbs a{color:var(--muted);text-decoration:none}
    .crumbs .sep{opacity:.5}

    .back{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:10px;background:transparent;border:1px solid var(--border);color:var(--text);cursor:pointer}

    .article{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .article h2{margin:0 0 4px}
    .article .meta{color:var(--muted);font-size:12px;margin-bottom:12px}
    .article .content{line-height:1.6}
    .article .content h2,.article .content h3{margin-top:18px}
    .article .content p{margin:10px 0}
    .article .content a{color:var(--brand)}

    /* таббар */
    .tabbar{position:fixed;left:0;right:0;bottom:0;background:rgba(16,18,24,.9);backdrop-filter:saturate(1.2) blur(6px);border-top:1px solid var(--border);padding:10px calc(env(safe-area-inset-left) + 8px) calc(env(safe-area-inset-bottom) + 10px);z-index:30}
    .tabbar .row{max-width:840px;margin:0 auto;display:flex;gap:8px;justify-content:space-between}
    .tab{flex:1;display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;color:var(--muted);background:transparent;border:0;cursor:pointer;padding:6px 8px;border-radius:12px}
    .tab.active{color:var(--text);background:rgba(96,165,250,.12);border:1px solid rgba(96,165,250,.35)}
    .tab .ico{width:18px;height:18px;opacity:.95}
    .tab .label{font-size:12px}

    .search{display:flex;gap:10px;margin:6px 0 14px}
    .search input{flex:1;background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="logo"><i>⌚</i> <b>База знаний</b> <span class="muted">· Demo</span></div>
    </div>
  </header>

  <main class="wrap">
    <!-- Категории -->
    <section id="view-cats" class="view active">
      <h3 style="margin:4px 0 12px">Категории</h3>
      <div id="cats-root" class="grid"></div>
    </section>

    <!-- Статьи (список) -->
    <section id="view-articles" class="view">
      <h3 style="margin:4px 0 10px">Статьи</h3>
      <div id="articles-list" class="list"></div>
    </section>

    <!-- Поиск -->
    <section id="view-search" class="view">
      <h3 style="margin:4px 0 6px">Поиск</h3>
      <div class="search">
        <input id="q" type="search" placeholder="Название, теги, текст…" />
      </div>
      <div id="search-res" class="list"></div>
    </section>

    <!-- Инфо -->
    <section id="view-info" class="view">
      <div class="card">
        <h3 style="margin:4px 0 10px">О приложении</h3>
        <p class="muted" style="margin:0">Это демо-витрина функционала: вкладки снизу, список категорий, статей, полнотекстовый поиск и просмотр статьи. Источник данных — Supabase через n8n (или локальные мок-данные, если API недоступен).</p>
      </div>
    </section>

    <!-- Динамические страницы: категория и статья -->
    <section id="page-category" class="view">
      <div class="crumbs"><a href="#/cats">Категории</a> <span class="sep">/</span> <span id="crumb-cat">…</span></div>
      <div id="cat-children" class="grid" style="margin-bottom:12px"></div>
      <div id="cat-articles" class="list"></div>
    </section>

    <section id="page-article" class="view">
      <button class="back" onclick="router.goBack()">← Назад</button>
      <div class="crumbs" style="margin-top:8px"><a href="#/cats">Категории</a> <span class="sep">/</span> <a id="crumb-cat2" href="#/cats">…</a> <span class="sep">/</span> <span id="crumb-title">…</span></div>
      <article class="article">
        <h2 id="art-title">…</h2>
        <div id="art-meta" class="meta">Обновлено …</div>
        <div id="art-content" class="content"></div>
      </article>
    </section>
  </main>

  <!-- Нижние вкладки -->
  <nav class="tabbar">
    <div class="row">
      <button class="tab active" data-tab="cats" onclick="ui.switchTab('cats')">
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 10h16M4 16h16M6 6h12"/></svg>
        <span class="label">Категории</span>
      </button>
      <button class="tab" data-tab="articles" onclick="ui.switchTab('articles')">
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M7 7h10M7 12h10M7 17h6"/></svg>
        <span class="label">Статьи</span>
      </button>
      <button class="tab" data-tab="search" onclick="ui.switchTab('search')">
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
        <span class="label">Поиск</span>
      </button>
      <button class="tab" data-tab="info" onclick="ui.switchTab('info')">
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="9"/><path d="M12 8.5h.01M11 12h2v5h-2z"/></svg>
        <span class="label">Ещё</span>
      </button>
    </div>
  </nav>

<script>
// === Конфиг ===
const BASE_API = ''; // пример: 'https://kb.your-domain.tld' (n8n, где опубликованы /kb/*)
const API = {
  cats: '/kb/categories',
  list: '/kb/articles',
  article: (id) => `/kb/article?id=${encodeURIComponent(id)}`,
};

// fallback: мок-данные, если API недоступен
const MOCK = {
  catsTree: [
    { id: 'movts', title: 'Механизмы', children: [
      { id: 'mech', title: 'Механические', children: [] },
      { id: 'quartz', title: 'Кварцевые', children: [] },
    ]},
    { id: 'brands', title: 'Бренды', children: [
      { id: 'seiko', title: 'Seiko', children: [] },
      { id: 'luch', title: 'Луч', children: [] },
    ]},
  ],
  articles: [
    { id: 'a1', title: 'Как работает автоматический подзавод', category_id: 'mech', summary: 'Принцип работы ротора и барабана', updated_at: '2025-08-18T10:00:00Z', content_html: '<p>Автоматический подзавод использует <b>ротор</b>, который вращается от движений руки…</p>'},
    { id: 'a2', title: 'Что такое сапфировое стекло', category_id: 'quartz', summary: 'Плюсы и минусы', updated_at: '2025-08-17T12:00:00Z', content_html: '<p>Сапфир — очень твёрдый материал (MOHS 9). Он устойчив к царапинам…</p>'},
    { id: 'a3', title: 'История бренда «Луч»', category_id: 'luch', summary: 'Минский часовой завод', updated_at: '2025-08-16T09:00:00Z', content_html: '<p>«Луч» — иконичные однострелочники, коллаборации и современное производство…</p>'},
  ],
};

const state = {
  catsTree: [],
  catsById: new Map(),
  articles: [],
  articleById: new Map(),
  history: [],
  useMock: false,
};

const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (tg) {
  try { tg.expand(); } catch(_){}
}

// обёртка над fetch с подписью Telegram
async function apiGet(path) {
  const url = (BASE_API ? BASE_API.replace(/\/$/, '') : '') + path;
  const headers = {};
  if (tg && tg.initData) headers['X-Init-Data'] = tg.initData;
  const res = await fetch(url, { headers });
  if (!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}

async function loadData() {
  try {
    const cats = await apiGet(API.cats); // ожидается { tree: [...] }
    state.catsTree = (Array.isArray(cats.tree) ? cats.tree : cats[0]?.tree) || [];
  } catch(e) {
    console.warn('Категории из API недоступны, использую мок-данные', e);
    state.catsTree = MOCK.catsTree; state.useMock = true;
  }
  // плоская карта категорий
  const walk = (arr, parent=null) => arr.forEach(n=>{ state.catsById.set(n.id, {...n,parent}); if(n.children?.length) walk(n.children,n.id); });
  state.catsById.clear(); walk(state.catsTree);

  try {
    const list = await apiGet(API.list); // ожидается массив
    state.articles = Array.isArray(list.list) ? list.list : (Array.isArray(list) ? list : []);
  } catch(e) {
    console.warn('Статьи из API недоступны, использую мок-данные', e);
    state.articles = MOCK.articles; state.useMock = true;
  }
  // карта статей (если API вернул без контента — подгрузим по требованию)
  state.articleById.clear();
  for (const a of state.articles) state.articleById.set(a.id, a);

  ui.renderCatsRoot();
  ui.renderArticles();
}

// === UI ===
const ui = {
  switchTab(name){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    const map = {cats:'view-cats', articles:'view-articles', search:'view-search', info:'view-info'};
    const id = map[name] || 'view-cats';
    document.getElementById(id).classList.add('active');
    router.push(`#/${name}`);
  },
  renderCatsRoot(){
    const root = document.getElementById('cats-root');
    root.innerHTML = '';
    state.catsTree.forEach(cat=>{
      const el = card(cat.title, ()=>router.goCat(cat.id));
      root.appendChild(el);
    });
  },
  renderCat(id){
    const cat = state.catsById.get(id); if(!cat) return;
    document.getElementById('crumb-cat').textContent = cat.title;
    document.getElementById('crumb-cat2').textContent = cat.title;
    document.getElementById('crumb-cat2').href = `#/category/${encodeURIComponent(id)}`;

    // дочерние категории
    const kids = document.getElementById('cat-children'); kids.innerHTML='';
    (cat.children||[]).forEach(c=>kids.appendChild(card(c.title,()=>router.goCat(c.id))));

    // статьи категории
    const list = document.getElementById('cat-articles'); list.innerHTML='';
    state.articles.filter(a=>a.category_id===id).forEach(a=>{
      list.appendChild(itemArticle(a));
    });
  },
  renderArticles(){
    const box = document.getElementById('articles-list'); box.innerHTML='';
    state.articles.forEach(a=> box.appendChild(itemArticle(a)) );
  },
  renderArticle(data){
    document.getElementById('art-title').textContent = data.title || 'Статья';
    const d = data.updated_at ? new Date(data.updated_at) : null;
    document.getElementById('art-meta').textContent = d ? `Обновлено ${d.toLocaleDateString('ru-RU')}` : '';
    document.getElementById('art-content').innerHTML = data.content_html || '<p class="muted">Нет содержимого.</p>';
  },
  renderSearch(q){
    const res = document.getElementById('search-res'); res.innerHTML='';
    const norm = (s)=> (s||'').toString().toLowerCase();
    const hit = state.articles.filter(a=>{
      const body = (state.articleById.get(a.id)?.content_html||'').replace(/<[^>]*>/g,' ');
      return norm(a.title).includes(q)||norm(a.summary).includes(q)||norm(body).includes(q);
    });
    hit.forEach(a=>res.appendChild(itemArticle(a)));
  }
};

function card(title, onClick){
  const el = document.createElement('div'); el.className='card click'; el.onclick=onClick;
  el.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><svg class="ico" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M6 8h12M6 12h12M6 16h8"/></svg><b>${escapeHtml(title)}</b></div>`;
  return el;
}

function itemArticle(a){
  const el = document.createElement('div'); el.className='item'; el.onclick=()=>router.goArticle(a.id);
  const cat = state.catsById.get(a.category_id); const catTitle = cat?cat.title:'Без категории';
  const date = a.updated_at ? new Date(a.updated_at).toLocaleDateString('ru-RU') : '';
  el.innerHTML = `
    <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M7 7h10M7 12h10M7 17h6"/></svg>
    <div>
      <h4>${escapeHtml(a.title)}</h4>
      <div class="meta">${escapeHtml(catTitle)} • ${date}</div>
      ${a.summary?`<div class="muted" style="margin-top:4px">${escapeHtml(a.summary)}</div>`:''}
    </div>`;
  return el;
}

function escapeHtml(s){
  return (s==null?'':String(s)).replace(/[&<>\"]/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[ch]));
}

// === Роутер (hash-based) ===
const router = {
  push(h){ if (location.hash!==h) location.hash=h; },
  goBack(){ history.back(); },
  goCat(id){ this.push(`#/category/${encodeURIComponent(id)}`); },
  goArticle(id){ this.push(`#/article/${encodeURIComponent(id)}`); },
  handle(){
    const h = location.hash || '#/cats';
    // вкладки
    if (/^#\/(cats|articles|search|info)$/.test(h)) {
      const tab = h.split('/')[1]; ui.switchTab(tab); return;
    }
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    // категория
    let m = h.match(/^#\/category\/([^/]+)/);
    if (m){ document.getElementById('page-category').classList.add('active'); ui.renderCat(decodeURIComponent(m[1])); return; }
    // статья
    m = h.match(/^#\/article\/([^/]+)/);
    if (m){ document.getElementById('page-article').classList.add('active'); loadArticle(decodeURIComponent(m[1])); return; }
    // дефолт
    ui.switchTab('cats');
  }
};
window.addEventListener('hashchange', ()=>router.handle());

async function loadArticle(id){
  let data = state.articleById.get(id);
  if (!data || !data.content_html) {
    if (!state.useMock) {
      try {
        const res = await apiGet(API.article(id));
        const row = Array.isArray(res) ? res[0] : (res.article||res);
        if (row) { data = { ...data, ...row }; state.articleById.set(id, data); }
      } catch(e) {
        console.warn('Не удалось загрузить статью по API', e);
      }
    }
    if (!data) { data = MOCK.articles.find(x=>x.id===id); }
  }
  if (data) ui.renderArticle(data);
}

// Поиск
const searchInput = document.getElementById('q');
searchInput?.addEventListener('input', e=> ui.renderSearch((e.target.value||'').toLowerCase()) );

// Первый запуск
loadData().then(()=> router.handle());
</script>
</body>
</html>
