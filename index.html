<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π ‚Äî WatchApp</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0b1220; --muted:#64748b; --accent:#2563eb; --line:#e5e7eb;
      --btn:#f1f5f9; --btn-border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);background:var(--bg)}
    header{position:fixed;inset:0 0 auto 0;height:56px;background:var(--card);border-bottom:1px solid var(--line);
      display:flex;align-items:center;gap:8px;padding:0 12px;z-index:10}
    .back-btn{display:flex;align-items:center;gap:8px;border:1px solid var(--btn-border);background:var(--btn);padding:6px 10px;
      border-radius:10px;cursor:pointer;font-weight:600;color:var(--text)}
    .back-btn svg{width:16px;height:16px}
    header h1{margin:0 auto 0 8px;font-size:18px;font-weight:700}
    main{max-width:960px;margin:76px auto 88px;padding:0 16px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    .title{font-size:22px;font-weight:800;margin:4px 0 10px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
    .btn{display:block;padding:12px 14px;border-radius:12px;border:1px solid var(--btn-border);background:var(--btn);color:var(--text);cursor:pointer;text-align:left}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .item{padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:var(--card);cursor:pointer}
    .item h4{margin:0 0 4px;font-size:16px}
    .loading,.empty{padding:10px 0;color:var(--muted)}
    .article{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    .article h1{margin:0 0 8px;font-size:22px}
    .tabs{position:fixed;inset:auto 0 0 0;height:68px;background:var(--card);border-top:1px solid var(--line);display:flex;z-index:10}
    .tabs button{flex:1;border:none;background:transparent;color:var(--muted);font-size:12px;display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;cursor:pointer}
    .tabs button.active{color:var(--accent);font-weight:600}
    a,.click{color:#1d4ed8;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <button class="back-btn" id="backBtn" title="–ù–∞–∑–∞–¥">
      <svg viewBox="0 0 20 20" fill="currentColor"><path d="M12.293 16.293a1 1 0 0 0 1.414-1.414L9.414 10l4.293-4.879a1 1 0 1 0-1.414-1.414l-5 5.683a1.5 1.5 0 0 0 0 2.12l5 4.783z"/></svg>
      –ù–∞–∑–∞–¥
    </button>
    <h1>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h1>
  </header>

  <main id="app"><div class="panel"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div></main>

  <footer class="tabs">
    <button data-tab="info" class="active">‚åö<span>–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span></button>
    <button data-tab="brands">üè∑Ô∏è<span>–ë—Ä–µ–Ω–¥—ã</span></button>
    <button data-tab="articles">üì∞<span>–°—Ç–∞—Ç—å–∏</span></button>
  </footer>

  <script>
    // ===== API =====
    const BASE_API = "https://n-8-n.tech/webhook"; // –ø—Ä–æ–¥-URL n8n (–±–µ–∑ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–≥–æ /)
    const API = {
      cats:    () => `${BASE_API}/kb/categories`,
      list:    (categoryId) => categoryId
                  ? `${BASE_API}/kb/articles?category=${encodeURIComponent(categoryId)}`
                  : `${BASE_API}/kb/articles`,
      article: (id) => `${BASE_API}/kb/article?id=${encodeURIComponent(id)}`
    };

    // ===== Telegram initData (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∫–∞–∫ WebApp) =====
    function getInitData(){
      try{
        return (window.Telegram && Telegram.WebApp && Telegram.WebApp.initData) ? Telegram.WebApp.initData : "";
      }catch(_){return ""}
    }
    async function apiGet(url){
      const headers = {};
      const initData = getInitData();
      if (initData) headers["X-Init-Data"] = initData;
      const res = await fetch(url,{headers});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      // –ø—Ä–æ–±—É–µ–º –∫–∞–∫ JSON, –∏–Ω–∞—á–µ –≤–µ—Ä–Ω—ë–º —Ç–µ–∫—Å—Ç
      try { return await res.json(); } catch { return await res.text(); }
    }

    // ===== —Å–æ—Å—Ç–æ—è–Ω–∏–µ / –∏—Å—Ç–æ—Ä–∏—è =====
    const app = document.getElementById("app");
    const backBtn = document.getElementById("backBtn");
    const nav = []; // –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–µ–∫
    const state = { tab:"info", tree:null, nodes:{ general:null, brands:null, levels:{} } };
    function push(view){ nav.push(view); render(view); }
    function back(){ nav.pop(); const v = nav[nav.length-1] || {type:"home",tab:state.tab}; render(v); }
    backBtn.onclick = () => back();

    // ===== —É—Ç–∏–ª–∏—Ç—ã =====
    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs||{})){
        if (k==="class") el.className=v;
        else if (k.startsWith("on")) el.addEventListener(k.slice(2), v);
        else el.setAttribute(k,v);
      }
      for (const c of children.flat()){
        el.appendChild(typeof c==="string" ? document.createTextNode(c) : (c||document.createTextNode("")));
      }
      return el;
    }
    function clear(){ app.innerHTML=""; }
    function setTab(tab){
      state.tab = tab;
      document.querySelectorAll(".tabs button").forEach(b => b.classList.toggle("active", b.dataset.tab===tab));
      nav.length = 0;
      push({type:"home",tab});
    }

    // ===== –∑–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ä–µ–≤–∞ =====
    async function loadTree(){
      const raw = await apiGet(API.cats());
      const tree = Array.isArray(raw) ? raw : (raw.tree || []);
      state.tree = tree;

      // –Ω–∞–π–¥—ë–º –∫–æ—Ä–Ω–∏ "–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" –∏ "–ë—Ä–µ–Ω–¥—ã"
      const byId = id => tree.find(n => n.id===id);
      const byTitle = t => tree.find(n => (n.title||"").toLowerCase().includes(t));
      state.nodes.general = byId("general") || byTitle("–æ–±—â");
      state.nodes.brands  = byId("brands")  || byTitle("–±—Ä–µ–Ω–¥");

      if (state.nodes.general){
        const kids = state.nodes.general.children || [];
        state.nodes.levels.basic    = kids.find(n => n.id==="basic")    || kids.find(n => /–±–∞–∑–æ–≤/i.test(n.title||""));
        state.nodes.levels.advanced = kids.find(n => n.id==="advanced") || kids.find(n => /–ø—Ä–æ–¥–≤–∏–Ω—É—Ç/i.test(n.title||""));
        state.nodes.levels.pro      = kids.find(n => n.id==="pro")      || kids.find(n => /–ø—Ä–æ—Ñ/i.test(n.title||""));
      }
    }

    // ===== —Ä–µ–Ω–¥–µ—Ä—ã =====
    function render(view){
      clear();
      const hasBack = !(view.type==="home");
      backBtn.style.visibility = hasBack ? "visible" : "hidden";

      if (view.type==="home"){
        if (view.tab==="info") renderInfoHome();
        if (view.tab==="brands") renderBrandsHome();
        if (view.tab==="articles") renderArticlesHome();
        return;
      }
      if (view.type==="level") renderLevel(view.levelKey);
      if (view.type==="category") renderCategory(view.category);
      if (view.type==="articles") renderArticlesForCategory(view.categoryId, view.title);
      if (view.type==="article") openArticle(view.id);
    }

    function renderInfoHome(){
      const g = state.nodes.general;
      const panel = h("div",{class:"panel"},
        h("div",{class:"title"},"–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"),
        h("div",{class:"grid"},
          h("button",{class:"btn",onclick:()=>push({type:"level",levelKey:"basic"})},"–ë–∞–∑–æ–≤—ã–π"),
          h("button",{class:"btn",onclick:()=>push({type:"level",levelKey:"advanced"})},"–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π"),
          h("button",{class:"btn",onclick:()=>push({type:"level",levelKey:"pro"})},"–ü—Ä–æ—Ñ–∏"),
        )
      );
      app.appendChild(panel);
    }

    function renderLevel(levelKey){
      const node = state.nodes.levels[levelKey];
      const title = node?.title || "–†–∞–∑–¥–µ–ª";
      const children = node?.children || [];
      const list = children.map(cat => h("div",{class:"item",onclick:()=>push({type:"category",category:cat})},
        h("h4",{},cat.title), h("div",{class:"muted"},"–û—Ç–∫—Ä—ã—Ç—å")
      ));
      app.appendChild(h("div",{class:"panel"}, h("div",{class:"title"},title), h("div",{class:"list"}, list.length?list:h("div",{class:"empty"},"–ü–æ–∫–∞ –Ω–µ—Ç —Ç–µ–º."))));
    }

    // –ö–∞—Ç–µ–≥–æ—Ä–∏—è –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å—Ä–∞–∑—É —Å—Ç–∞—Ç—å–∏.
    function renderCategory(cat){
      const kids = cat.children || [];
      if (kids.length){
        const list = kids.map(c => h("div",{class:"item",onclick:()=>push({type:"articles",categoryId:c.id,title:c.title})},
          h("h4",{},c.title), h("div",{class:"muted"},"–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—å–∏")
        ));
        app.appendChild(h("div",{class:"panel"}, h("div",{class:"title"},cat.title), h("div",{class:"list"},list)));
      } else {
        push({type:"articles",categoryId:cat.id,title:cat.title});
      }
    }

    function renderBrandsHome(){
      const b = state.nodes.brands;
      const kids = b?.children || [];
      const list = kids.map(cat => h("div",{class:"item",onclick:()=>push({type:"articles",categoryId:cat.id,title:cat.title})},
        h("h4",{},cat.title)
      ));
      app.appendChild(h("div",{class:"panel"}, h("div",{class:"title"},"–ë—Ä–µ–Ω–¥—ã"), h("div",{class:"list"}, list.length?list:h("div",{class:"empty"},"–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–æ–≤ –±—Ä–µ–Ω–¥–æ–≤."))));
    }

    async function renderArticlesHome(){
      const box = h("div",{class:"panel"}, h("div",{class:"title"},"–í—Å–µ —Å—Ç–∞—Ç—å–∏"), h("div",{class:"loading"},"–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶"));
      app.appendChild(box);
      try{
        const data = await apiGet(API.list());
        const items = Array.isArray(data)?data:(data.items||[]);
        if (items.length===1){ push({type:"article",id:items[0].id}); return; }
        const list = items.length
          ? h("div",{class:"list"}, items.map(a => h("div",{class:"item",onclick:()=>push({type:"article",id:a.id})},
                h("h4",{},a.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"), a.summary?h("div",{class:"muted"},a.summary):null )))
          : h("div",{class:"empty"},"–ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–µ–π.");
        box.lastChild.replaceWith(list);
      }catch{ box.lastChild.replaceWith(h("div",{class:"empty"},"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.")); }
    }

    async function renderArticlesForCategory(categoryId, title){
      const box = h("div",{class:"panel"}, h("div",{class:"title"}, title||"–°—Ç–∞—Ç—å–∏"), h("div",{class:"loading"},"–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶"));
      app.appendChild(box);
      try{
        const data = await apiGet(API.list(categoryId));
        const items = Array.isArray(data)?data:(data.items||[]);
        if (items.length===1){ push({type:"article",id:items[0].id}); return; }
        const list = items.length
          ? h("div",{class:"list"}, items.map(a => h("div",{class:"item",onclick:()=>push({type:"article",id:a.id})},
                h("h4",{},a.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"), a.summary?h("div",{class:"muted"},a.summary):null )))
          : h("div",{class:"empty"},"–°—Ç–∞—Ç–µ–π –≤ —ç—Ç–æ–π —Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç.");
        box.lastChild.replaceWith(list);
      }catch{ box.lastChild.replaceWith(h("div",{class:"empty"},"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–µ–π.")); }
    }

    async function openArticle(id){
      const box = h("div",{class:"panel"}, h("div",{class:"loading"},"–û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—å—é‚Ä¶"));
      app.appendChild(box);
      try{
        const data = await apiGet(API.article(id));
        const a = data.article || (Array.isArray(data)?data[0]:data);
        const art = h("div",{class:"article"});
        art.innerHTML = `<h1>${escapeHtml(a?.title||"–°—Ç–∞—Ç—å—è")}</h1>` + (a?.content_html||"<p class='muted'>–ü—É—Å—Ç–æ</p>");
        box.lastChild.replaceWith(art);
      }catch{ box.lastChild.replaceWith(h("div",{class:"empty"},"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å—é.")); }
    }

    function escapeHtml(s){return String(s).replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));}

    // –∑–∞–ø—É—Å–∫
    (async()=>{
      try{ await loadTree(); }catch{ app.innerHTML=`<div class="panel"><div class="empty">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É.</div></div>`; return; }
      // –≤–∫–ª–∞–¥–∫–∏
      document.querySelectorAll(".tabs button").forEach(b => b.onclick = ()=>setTab(b.dataset.tab));
      setTab("info");
    })();
  </script>
</body>
</html>
